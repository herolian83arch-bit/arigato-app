<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>オノマトペ辞典 - 例文 | Arigato App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1 id="scene-title">オノマトペ辞典</h1>
      <div class="back-navigation">
        <button class="back-btn" onclick="window.location.href='onomatopoeia-scenes.html'">← シーン選択に戻る</button>
      </div>

      <!-- 言語選択ボタン -->
      <div class="language-selector">
        <div class="language-buttons">
          <button class="lang-btn active" data-lang="ja" onclick="changeLanguage('ja')">日本語</button>
          <button class="lang-btn" data-lang="en" onclick="changeLanguage('en')">English</button>
          <button class="lang-btn" data-lang="zh" onclick="changeLanguage('zh')">中文</button>
          <button class="lang-btn" data-lang="ko" onclick="changeLanguage('ko')">한국어</button>
          <button class="lang-btn" data-lang="de" onclick="changeLanguage('de')">Deutsch</button>
          <button class="lang-btn" data-lang="fr" onclick="changeLanguage('fr')">Français</button>
          <button class="lang-btn" data-lang="it" onclick="changeLanguage('it')">Italiano</button>
          <button class="lang-btn" data-lang="tw" onclick="changeLanguage('tw')">繁體中文</button>
        </div>
      </div>
    </header>

    <main>
      <div id="examples-container">
        <!-- 例文はJavaScriptで動的に生成 -->
      </div>
    </main>
  </div>

  <script src="translation-api.js"></script>
  <script>
    let onomatopoeiaData = [];
    let currentScene = '';
    let currentLanguage = 'ja'; // 現在選択されている言語
    let translatedSceneItems = []; // 翻訳された例文のキャッシュ

    // プレミアム状態の確認
    document.addEventListener('DOMContentLoaded', async function() {
      const isPremium = localStorage.getItem('premiumActive') === 'true';
      if (!isPremium) {
        // プレミアムユーザーでない場合はトップページにリダイレクト
        window.location.href = 'index.html';
        return;
      }

      // URLパラメータからシーン名を取得
      const urlParams = new URLSearchParams(window.location.search);
      currentScene = urlParams.get('scene');

      if (!currentScene) {
        // シーン名が指定されていない場合はシーン選択画面に戻る
        window.location.href = 'onomatopoeia-scenes.html';
        return;
      }

      // シーンタイトルを更新
      document.getElementById('scene-title').textContent = currentScene;

      // オノマトペデータを読み込み
      await loadOnomatopoeiaData();
      // 例文を表示
      displayExamples();
    });

    // オノマトペデータを読み込み
    async function loadOnomatopoeiaData() {
      try {
        const response = await fetch('/data/dictionary.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const rawData = await response.json();

        // romajiを大文字に変換
        onomatopoeiaData = rawData.map(item => ({
          ...item,
          romaji: item.romaji ? item.romaji.toUpperCase() : item.romaji
        }));

        console.log(`📚 Loaded ${onomatopoeiaData.length} onomatopoeia entries`);
      } catch (error) {
        console.error('オノマトペデータの読み込みに失敗:', error);
        onomatopoeiaData = [];
      }
    }

    // 例文を表示
    function displayExamples() {
      const examplesContainer = document.getElementById('examples-container');

      // 表示する例文を決定（翻訳済みがあれば使用、なければ元のデータ）
      const displayItems = translatedSceneItems.length > 0 ? translatedSceneItems : onomatopoeiaData.filter(item => item.scene === currentScene);

      if (displayItems.length === 0) {
        examplesContainer.innerHTML = '<p>このシーンの例文が見つかりませんでした。</p>';
        return;
      }

      let html = '';
      for (const item of displayItems) {
        // 音声再生機能の有効/無効チェック
        const isTTSEnabled = localStorage.getItem('feature_tts') === '1' ||
                             (typeof window !== 'undefined' && window.speechSynthesis);

        html += `
          <div class="onomatopoeia-item" data-testid="dict-row">
            <div class="item-header">
              <div class="item-number">${item.id}</div>
              <div class="item-actions" style="display:inline-flex;align-items:center;">
                ${isTTSEnabled ? `
                  <button class="speak-btn" onclick="playAudio('${item.main.replace(/'/g, "\\'")}')" aria-label="音声再生" style="background:none;border:none;cursor:pointer;font-size:1.2em;margin-left:12px;" data-card-control="true">
                    🔊
                  </button>
                ` : ''}
                <button class="favorite-toggle-btn" data-card-control="true" aria-label="お気に入りに追加" style="background:none;border:none;cursor:pointer;padding:8px;margin-left:12px;font-size:1.3em;color:#bbb;min-width:40px;min-height:40px;display:inline-flex;align-items:center;justify-content:center;transition:all 0.2s ease;border-radius:4px;position:relative;z-index:10;pointer-events:auto;" onclick="toggleFavorite(${item.id}, this)">
                  ${isFavorite(item.id) ? '★' : '☆'}
                </button>
              </div>
            </div>
            <div class="item-main">${item.main}</div>
            <div class="item-romaji">${item.romaji}</div>
            <div class="item-description">${item.description?.ja || ''}</div>
          </div>
        `;
      }

      examplesContainer.innerHTML = html;
    }

    // 音声再生
    function playAudio(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ja-JP';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 0.9;
        speechSynthesis.speak(utterance);
      }
    }

    // お気に入り状態の確認
    function isFavorite(id) {
      if (!id) return false;
      try {
        const favorites = JSON.parse(localStorage.getItem('arigato_favorites_v1') || '{}');
        return favorites[String(id)] === true;
      } catch {
        return false;
      }
    }

    // お気に入りの切り替え
    function toggleFavorite(id, button) {
      if (!id) return false;

      try {
        const favorites = JSON.parse(localStorage.getItem('arigato_favorites_v1') || '{}');
        const stringId = String(id);
        const currentState = favorites[stringId] || false;
        const newState = !currentState;

        favorites[stringId] = newState;
        localStorage.setItem('arigato_favorites_v1', JSON.stringify(favorites));

        // UI更新
        if (newState) {
          button.innerHTML = '★';
          button.style.color = '#ffd700';
          button.style.transform = 'scale(1.1)';
          button.setAttribute('aria-label', 'お気に入りから削除');
          button.setAttribute('aria-pressed', 'true');
        } else {
          button.innerHTML = '☆';
          button.style.color = '#bbb';
          button.style.transform = 'scale(1)';
          button.setAttribute('aria-label', 'お気に入りに追加');
          button.setAttribute('aria-pressed', 'false');
        }

        return newState;
      } catch (error) {
        console.warn('Failed to toggle favorite:', error);
        return false;
      }
    }

    // 言語を切り替え
    async function changeLanguage(lang) {
      if (lang === currentLanguage) return;

      // 言語ボタンのアクティブ状態を更新
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-lang="${lang}"]`).classList.add('active');

      currentLanguage = lang;

      // 翻訳中のローディング表示
      showLoading();

      try {
        if (lang === 'ja') {
          // 日本語の場合は翻訳不要
          translatedSceneItems = [];
        } else {
          // 現在のシーンの例文を翻訳
          await translateSceneItems(lang);
        }

        // 例文を再表示
        displayExamples();
      } catch (error) {
        console.error('言語切り替えエラー:', error);
        // エラー時は元の言語に戻す
        currentLanguage = 'ja';
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector('[data-lang="ja"]').classList.add('active');
      } finally {
        hideLoading();
      }
    }

    // シーンの例文を翻訳
    async function translateSceneItems(targetLang) {
      if (targetLang === 'ja') return;

      const sceneItems = onomatopoeiaData.filter(item => item.scene === currentScene);

      try {
        translatedSceneItems = await window.translationAPI.translateSceneItems(sceneItems, targetLang);
        console.log(`✅ シーン例文の翻訳完了: ${translatedSceneItems.length}件`);
      } catch (error) {
        console.error('シーン例文翻訳エラー:', error);
        translatedSceneItems = sceneItems; // エラー時は元の例文
      }
    }

    // ローディング表示
    function showLoading() {
      const examplesContainer = document.getElementById('examples-container');
      examplesContainer.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>翻訳中...</p>
        </div>
      `;
    }

    // ローディング非表示
    function hideLoading() {
      // ローディングは自動的にdisplayExamples()で解除される
    }
  </script>
</body>
</html>
