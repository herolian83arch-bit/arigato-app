<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ªãƒãƒãƒˆãƒšè¾å…¸ - ã‚·ãƒ¼ãƒ³é¸æŠ | Arigato App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>ã‚ªãƒãƒãƒˆãƒšè¾å…¸</h1>
      <div class="back-navigation">
        <button class="back-btn" onclick="window.location.href='premium-features.html'">â† ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã«æˆ»ã‚‹</button>
      </div>

      <!-- è¨€èªé¸æŠãƒœã‚¿ãƒ³ -->
      <div class="language-selector">
        <div class="language-buttons">
          <button class="lang-btn active" data-lang="ja" onclick="changeLanguage('ja')">æ—¥æœ¬èª</button>
          <button class="lang-btn" data-lang="en" onclick="changeLanguage('en')">English</button>
          <button class="lang-btn" data-lang="zh" onclick="changeLanguage('zh')">ä¸­æ–‡</button>
          <button class="lang-btn" data-lang="ko" onclick="changeLanguage('ko')">í•œêµ­ì–´</button>
          <button class="lang-btn" data-lang="de" onclick="changeLanguage('de')">Deutsch</button>
          <button class="lang-btn" data-lang="fr" onclick="changeLanguage('fr')">FranÃ§ais</button>
          <button class="lang-btn" data-lang="it" onclick="changeLanguage('it')">Italiano</button>
          <button class="lang-btn" data-lang="tw" onclick="changeLanguage('tw')">ç¹é«”ä¸­æ–‡</button>
        </div>
      </div>
    </header>

    <main>
      <div class="scenes-intro">
        <p>å­¦ç¿’ã—ãŸã„ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      </div>

      <div id="scenes-grid" class="scene-grid">
        <!-- ã‚·ãƒ¼ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </main>
  </div>

  <script src="translation-api.js"></script>
  <script>
    let onomatopoeiaData = [];
    let currentLanguage = 'ja'; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹è¨€èª
    let translatedSceneTitles = {}; // ç¿»è¨³ã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥

    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã®ç¢ºèª
    document.addEventListener('DOMContentLoaded', async function() {
      const isPremium = localStorage.getItem('premiumActive') === 'true';
      if (!isPremium) {
        // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„å ´åˆã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = 'index.html';
        return;
      }

      // ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await loadOnomatopoeiaData();
      // ã‚·ãƒ¼ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
      displayScenes();
    });

    // ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadOnomatopoeiaData() {
      try {
        const response = await fetch('/data/dictionary.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const rawData = await response.json();

        // romajiã‚’å¤§æ–‡å­—ã«å¤‰æ›
        onomatopoeiaData = rawData.map(item => ({
          ...item,
          romaji: item.romaji ? item.romaji.toUpperCase() : item.romaji
        }));

        console.log(`ğŸ“š Loaded ${onomatopoeiaData.length} onomatopoeia entries`);
      } catch (error) {
        console.error('ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        onomatopoeiaData = [];
      }
    }

    // ã‚·ãƒ¼ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
    function displayScenes() {
      const scenesContainer = document.getElementById('scenes-grid');

      // ã‚·ãƒ¼ãƒ³ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const sceneGroups = {};
      onomatopoeiaData.forEach(item => {
        if (!sceneGroups[item.scene]) {
          sceneGroups[item.scene] = [];
        }
        sceneGroups[item.scene].push(item);
      });

      let html = '';
      Object.keys(sceneGroups).forEach(scene => {
        const count = sceneGroups[scene].length;
        const displayTitle = translatedSceneTitles[scene] || scene;
        html += `
          <div class="scene-card" onclick="selectScene('${scene}')">
            <div class="scene-icon">ğŸ“š</div>
            <div class="scene-title">${displayTitle}</div>
            <div class="scene-count">${count}ä¾‹æ–‡</div>
          </div>
        `;
      });

      scenesContainer.innerHTML = html;
    }

    // ã‚·ãƒ¼ãƒ³ã‚’é¸æŠ
    function selectScene(scene) {
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚·ãƒ¼ãƒ³åã‚’æ¸¡ã™
      const encodedScene = encodeURIComponent(scene);
      window.location.href = `onomatopoeia-examples.html?scene=${encodedScene}`;
    }

    // è¨€èªã‚’åˆ‡ã‚Šæ›¿ãˆ
    async function changeLanguage(lang) {
      if (lang === currentLanguage) return;

      // è¨€èªãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-lang="${lang}"]`).classList.add('active');

      currentLanguage = lang;

      // ç¿»è¨³ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      showLoading();

      try {
        if (lang === 'ja') {
          // æ—¥æœ¬èªã®å ´åˆã¯ç¿»è¨³ä¸è¦
          translatedSceneTitles = {};
        } else {
          // ã‚·ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³
          await translateSceneTitles(lang);
        }

        // ã‚·ãƒ¼ãƒ³ä¸€è¦§ã‚’å†è¡¨ç¤º
        displayScenes();
      } catch (error) {
        console.error('è¨€èªåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®è¨€èªã«æˆ»ã™
        currentLanguage = 'ja';
          document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          document.querySelector('[data-lang="ja"]').classList.add('active');
      } finally {
        hideLoading();
      }
    }

    // ã‚·ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³
    async function translateSceneTitles(targetLang) {
      if (targetLang === 'ja') return;

      const sceneGroups = {};
      onomatopoeiaData.forEach(item => {
        if (!sceneGroups[item.scene]) {
          sceneGroups[item.scene] = [];
        }
        sceneGroups[item.scene].push(item);
      });

      const sceneTitles = Object.keys(sceneGroups);

      for (const sceneTitle of sceneTitles) {
        try {
          const translatedTitle = await window.translationAPI.translateSceneTitle(sceneTitle, targetLang);
          translatedSceneTitles[sceneTitle] = translatedTitle;

          // APIåˆ¶é™ã‚’è€ƒæ…®ã—ã¦å°‘ã—å¾…æ©Ÿ
          await new Promise(resolve => setTimeout(resolve, 200));
        } catch (error) {
          console.error(`ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ç¿»è¨³ã‚¨ãƒ©ãƒ¼ (${sceneTitle}):`, error);
          translatedSceneTitles[sceneTitle] = sceneTitle; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«
        }
      }
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      const scenesContainer = document.getElementById('scenes-grid');
      scenesContainer.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>ç¿»è¨³ä¸­...</p>
        </div>
      `;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
    function hideLoading() {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è‡ªå‹•çš„ã«displayScenes()ã§è§£é™¤ã•ã‚Œã‚‹
    }
  </script>
</body>
</html>
