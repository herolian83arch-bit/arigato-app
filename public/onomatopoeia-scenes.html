<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ªãƒãƒãƒˆãƒšè¾å…¸ - ã‚·ãƒ¼ãƒ³é¸æŠ | Arigato App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Onomatopoeia Dictionary</h1>
      <div class="back-navigation">
        <button class="back-btn" onclick="window.location.href='premium-features.html'">â† Back</button>
      </div>

      <!-- è¨€èªé¸æŠãƒœã‚¿ãƒ³ -->
      <div class="lang-container">
        <button class="lang-btn active" data-lang="ja" onclick="changeLanguage('ja')">æ—¥æœ¬èª</button>
        <button class="lang-btn" data-lang="en" onclick="changeLanguage('en')">English</button>
        <button class="lang-btn" data-lang="zh" onclick="changeLanguage('zh')">ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="ko" onclick="console.log('ğŸ”´ éŸ“å›½èªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯'); console.log('ğŸ”´ changeLanguageé–¢æ•°ã®å­˜åœ¨ç¢ºèª:', typeof changeLanguage); changeLanguage('ko'); console.log('ğŸ”´ changeLanguageå‘¼ã³å‡ºã—å¾Œ');">í•œêµ­ì–´</button>
        <button class="lang-btn" data-lang="de" onclick="changeLanguage('de')">Deutsch</button>
        <button class="lang-btn" data-lang="fr" onclick="changeLanguage('fr')">FranÃ§ais</button>
        <button class="lang-btn" data-lang="it" onclick="changeLanguage('it')">Italiano</button>
        <button class="lang-btn" data-lang="zh-TW" onclick="changeLanguage('zh-TW')">ç¹é«”ä¸­æ–‡</button>
      </div>
    </header>

    <main>
      <div class="scenes-intro">
        <p id="scenes-intro-text">Please select the scene you want to learn</p>
      </div>

      <div id="scenes-grid" class="scene-grid">
        <!-- ã‚·ãƒ¼ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
      </div>
    </main>
  </div>

    <script src="translation-api.js"></script>
    <script src="translation-batch.js"></script>
    <script src="translation-cache.js"></script>
  <script>
    let onomatopoeiaData = [];
    let currentLanguage = 'ja';
    let translationAPI = null;
    let batchTranslationManager = null;
    let translationCache = null;

    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã®ç¢ºèª
    document.addEventListener('DOMContentLoaded', async function() {
      const isPremium = localStorage.getItem('premiumActive') === 'true';
      if (!isPremium) {
        // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„å ´åˆã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = 'index.html';
        return;
      }

      // ç¿»è¨³APIã®åˆæœŸåŒ–
      translationAPI = new TranslationAPI();
      batchTranslationManager = window.batchTranslationManager;
      translationCache = window.translationCache;

      // ä¿å­˜ã•ã‚ŒãŸè¨€èªè¨­å®šã‚’å¾©å…ƒ
      const savedLanguage = localStorage.getItem('onomatopoeiaLanguage') || 'ja';
      currentLanguage = savedLanguage;
      updateLanguageButtons();

      // æ—¥æœ¬èªä»¥å¤–ã®å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’é–‹å§‹
      if (currentLanguage !== 'ja') {
        console.log('ğŸ”„ åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹');
        showLoading();
      }

      // ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await loadOnomatopoeiaData();
      // ã‚·ãƒ¼ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
      await displayScenes();

      // æ—¥æœ¬èªä»¥å¤–ã®å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’çµ‚äº†
      if (currentLanguage !== 'ja') {
        console.log('ğŸ”„ åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†');
        hideLoading();
      }
    });

    // ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadOnomatopoeiaData() {
      try {
        const response = await fetch('/data/dictionary.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const rawData = await response.json();

        // romajiã‚’å¤§æ–‡å­—ã«å¤‰æ›
        onomatopoeiaData = rawData.map(item => ({
          ...item,
          romaji: item.romaji ? item.romaji.toUpperCase() : item.romaji
        }));

        console.log(`ğŸ“š Loaded ${onomatopoeiaData.length} onomatopoeia entries`);
      } catch (error) {
        console.error('ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        onomatopoeiaData = [];
      }
    }

                // è¨€èªåˆ‡ã‚Šæ›¿ãˆ
    async function changeLanguage(lang) {
      console.log('ğŸ”„ changeLanguage é–‹å§‹:', lang);
      console.log('ğŸ”„ ç¾åœ¨ã®è¨€èª:', currentLanguage);
      console.log('ğŸ”„ å¼•æ•°ã®è¨€èª:', lang);

      if (currentLanguage === lang) {
        console.log('âš ï¸ åŒã˜è¨€èªãªã®ã§å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      console.log('ğŸ”„ è¨€èªè¨­å®šã‚’å¤‰æ›´ä¸­...');
      currentLanguage = lang;
      console.log('ğŸ”„ æ–°ã—ã„è¨€èªè¨­å®š:', currentLanguage);

      console.log('ğŸ”„ localStorage ã«ä¿å­˜ä¸­...');
      localStorage.setItem('onomatopoeiaLanguage', lang);
      console.log('âœ… localStorage ä¿å­˜å®Œäº†');

      console.log('ğŸ”„ è¨€èªãƒœã‚¿ãƒ³ã‚’æ›´æ–°ä¸­...');
      updateLanguageButtons();
      console.log('âœ… è¨€èªãƒœã‚¿ãƒ³æ›´æ–°å®Œäº†');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’é–‹å§‹
      console.log('ğŸ“± showLoading() å‘¼ã³å‡ºã—å‰');
      console.log('ğŸ“± showLoading é–¢æ•°ã®å­˜åœ¨ç¢ºèª:', typeof showLoading);
      showLoading();
      console.log('ğŸ“± showLoading() å‘¼ã³å‡ºã—å¾Œ');

      try {
        console.log('ğŸ”„ displayScenes() å‘¼ã³å‡ºã—é–‹å§‹');
        // ã‚·ãƒ¼ãƒ³ä¸€è¦§ã‚’å†è¡¨ç¤ºï¼ˆç¿»è¨³ä»˜ãï¼‰
        await displayScenes();
        console.log('âœ… displayScenes() å®Œäº†');

        // æœ€å°è¡¨ç¤ºæ™‚é–“ã‚’ç¢ºä¿ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºå®Ÿã«è¦‹ã›ã‚‹ãŸã‚ï¼‰
        console.log('â±ï¸ 800ms å¾…æ©Ÿé–‹å§‹');
        await new Promise(resolve => setTimeout(resolve, 800));
        console.log('â±ï¸ 800ms å¾…æ©Ÿå®Œäº†');
      } finally {
        // å¿…ãšãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’çµ‚äº†
        console.log('ğŸ“± hideLoading() å‘¼ã³å‡ºã—');
        hideLoading();
        console.log('âœ… changeLanguage å®Œäº†');
      }
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®åˆ¶å¾¡
    function showLoading() {
      console.log('ğŸ“± showLoading() å®Ÿè¡Œé–‹å§‹');
      console.log('ğŸ“± document ã®çŠ¶æ…‹:', document.readyState);
      console.log('ğŸ“± document.getElementById ã®å­˜åœ¨ç¢ºèª:', typeof document.getElementById);

      const loadingIndicator = document.getElementById('loading-indicator');
      console.log('ğŸ“± loadingIndicator è¦ç´ :', loadingIndicator);
      console.log('ğŸ“± loadingIndicator ã®å‹:', typeof loadingIndicator);
      console.log('ğŸ“± loadingIndicator ã® tagName:', loadingIndicator ? loadingIndicator.tagName : 'null');
      console.log('ğŸ“± loadingIndicator ã® id:', loadingIndicator ? loadingIndicator.id : 'null');
      console.log('ğŸ“± loadingIndicator ã®ç¾åœ¨ã® style.display:', loadingIndicator ? loadingIndicator.style.display : 'null');

      if (loadingIndicator) {
        console.log('ğŸ“± style.display ã‚’ block ã«è¨­å®šä¸­...');
        loadingIndicator.style.display = 'block';
        console.log('ğŸ“± è¨­å®šå¾Œã® style.display:', loadingIndicator.style.display);
        console.log('âœ… ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
      } else {
        console.error('âŒ loading-indicator è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('âŒ document å…¨ä½“ã‚’ç¢ºèª:', document);
        console.error('âŒ å…¨ã¦ã®è¦ç´ ã‚’ç¢ºèª:', document.querySelectorAll('*'));
      }
    }

    function hideLoading() {
      console.log('ğŸ“± hideLoading() å®Ÿè¡Œé–‹å§‹');
      const loadingIndicator = document.getElementById('loading-indicator');
      console.log('ğŸ“± loadingIndicator è¦ç´ :', loadingIndicator);
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
        console.log('âœ… ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
      } else {
        console.error('âŒ loading-indicator è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }

    // è¨€èªãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    function updateLanguageButtons() {
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.lang === currentLanguage) {
          btn.classList.add('active');
        }
      });
    }

    // ã‚·ãƒ¼ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
    async function displayScenes() {
      console.log('ğŸ”„ displayScenes() é–‹å§‹, ç¾åœ¨ã®è¨€èª:', currentLanguage);
      const scenesContainer = document.getElementById('scenes-grid');
      if (!scenesContainer) {
        console.error('âŒ scenes-grid è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ã‚·ãƒ¼ãƒ³ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const sceneGroups = {};
      onomatopoeiaData.forEach(item => {
        if (!sceneGroups[item.scene]) {
          sceneGroups[item.scene] = [];
        }
        sceneGroups[item.scene].push(item);
      });

      let html = '';
      const scenes = Object.keys(sceneGroups);
      console.log('ğŸ“Š ã‚·ãƒ¼ãƒ³æ•°:', scenes.length, 'ã‚·ãƒ¼ãƒ³:', scenes);

      // æ—¥æœ¬èªä»¥å¤–ã®å ´åˆã¯ç¿»è¨³ã‚’å®Ÿè¡Œ
      if (currentLanguage !== 'ja') {
        console.log('ğŸŒ ç¿»è¨³å‡¦ç†é–‹å§‹, è¨€èª:', currentLanguage);
        try {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ç¿»è¨³çµæœã‚’å–å¾—
          let translatedScenes = translationCache.get('scene_titles', currentLanguage);

          if (!translatedScenes) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã„å ´åˆã¯ç¿»è¨³ã‚’å®Ÿè¡Œ
            console.log(`ğŸš€ ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ç¿»è¨³é–‹å§‹: ${currentLanguage}`);
            translatedScenes = await translationAPI.translateMultipleTexts(scenes, currentLanguage);

            // ç¿»è¨³çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            translationCache.set('scene_titles', currentLanguage, translatedScenes);
          } else {
            console.log(`ğŸ“¦ ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: ${currentLanguage}`);
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã‚‚å°‘ã—å¾…æ©Ÿã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¶­æŒ
            await new Promise(resolve => setTimeout(resolve, 500));
          }

          for (let i = 0; i < scenes.length; i++) {
            const originalScene = scenes[i];
            const translatedScene = translatedScenes[i];
            const count = sceneGroups[originalScene].length;

            html += `
              <div class="scene-card" onclick="selectScene('${originalScene}')">
                <div class="scene-icon">ğŸ“š</div>
                <div class="scene-title">${translatedScene}</div>
              </div>
            `;
          }

        } catch (error) {
          console.error('ã‚·ãƒ¼ãƒ³ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ã‚·ãƒ¼ãƒ³åã§è¡¨ç¤º
          scenes.forEach(scene => {
            const count = sceneGroups[scene].length;
            html += `
              <div class="scene-card" onclick="selectScene('${scene}')">
                <div class="scene-icon">ğŸ“š</div>
                <div class="scene-title">${scene}</div>
              </div>
            `;
          });
        } finally {
          // ç¿»è¨³å‡¦ç†å®Œäº†ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¯ changeLanguage é–¢æ•°ã§åˆ¶å¾¡ï¼‰
        }
      } else {
        // æ—¥æœ¬èªã®å ´åˆã¯ç¿»è¨³ä¸è¦
        scenes.forEach(scene => {
          const count = sceneGroups[scene].length;
          html += `
            <div class="scene-card" onclick="selectScene('${scene}')">
              <div class="scene-icon">ğŸ“š</div>
              <div class="scene-title">${scene}</div>
            </div>
          `;
        });
      }

      scenesContainer.innerHTML = html;
    }

    // ã‚·ãƒ¼ãƒ³ã‚’é¸æŠ
    function selectScene(scene) {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’é–‹å§‹
      showLoading();

      // å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºå®Ÿã«è¦‹ã›ã‚‹ãŸã‚ï¼‰
      setTimeout(() => {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚·ãƒ¼ãƒ³åã¨è¨€èªè¨­å®šã‚’æ¸¡ã™
        const encodedScene = encodeURIComponent(scene);
        window.location.href = `onomatopoeia-examples.html?scene=${encodedScene}&lang=${currentLanguage}`;
      }, 300);
    }
  </script>
</body>
</html>
