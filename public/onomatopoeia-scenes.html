<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>オノマトペ辞典 - シーン選択 | Arigato App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Onomatopoeia Dictionary</h1>
      <div class="back-navigation">
        <button class="back-btn" onclick="window.location.href='premium-features.html'">← Back</button>
      </div>

      <!-- 言語選択ボタン -->
      <div class="lang-container">
        <button class="lang-btn active" data-lang="ja" onclick="changeLanguage('ja')">日本語</button>
        <button class="lang-btn" data-lang="en" onclick="changeLanguage('en')">English</button>
        <button class="lang-btn" data-lang="zh" onclick="changeLanguage('zh')">中文</button>
        <button class="lang-btn" data-lang="ko" onclick="console.log('🔴 韓国語ボタンクリック'); console.log('🔴 changeLanguage関数の存在確認:', typeof changeLanguage); changeLanguage('ko'); console.log('🔴 changeLanguage呼び出し後');">한국어</button>
        <button class="lang-btn" data-lang="de" onclick="changeLanguage('de')">Deutsch</button>
        <button class="lang-btn" data-lang="fr" onclick="changeLanguage('fr')">Français</button>
        <button class="lang-btn" data-lang="it" onclick="changeLanguage('it')">Italiano</button>
        <button class="lang-btn" data-lang="zh-TW" onclick="changeLanguage('zh-TW')">繁體中文</button>
      </div>
    </header>

    <main>
      <div class="scenes-intro">
        <p id="scenes-intro-text">Please select the scene you want to learn</p>
      </div>

      <div id="scenes-grid" class="scene-grid">
        <!-- シーンはJavaScriptで動的に生成 -->
      </div>

      <!-- ローディング表示 -->
      <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
      </div>
    </main>
  </div>

    <script src="translation-api.js"></script>
    <script src="translation-batch.js"></script>
    <script src="translation-cache.js"></script>
  <script>
    let onomatopoeiaData = [];
    let currentLanguage = 'ja';
    let translationAPI = null;
    let batchTranslationManager = null;
    let translationCache = null;

    // プレミアム状態の確認
    document.addEventListener('DOMContentLoaded', async function() {
      const isPremium = localStorage.getItem('premiumActive') === 'true';
      if (!isPremium) {
        // プレミアムユーザーでない場合はトップページにリダイレクト
        window.location.href = 'index.html';
        return;
      }

      // 翻訳APIの初期化
      translationAPI = new TranslationAPI();
      batchTranslationManager = window.batchTranslationManager;
      translationCache = window.translationCache;

      // 保存された言語設定を復元
      const savedLanguage = localStorage.getItem('onomatopoeiaLanguage') || 'ja';
      currentLanguage = savedLanguage;
      updateLanguageButtons();

      // 日本語以外の場合はローディング表示を開始
      if (currentLanguage !== 'ja') {
        console.log('🔄 初期読み込み時のローディング表示開始');
        showLoading();
      }

      // オノマトペデータを読み込み
      await loadOnomatopoeiaData();
      // シーン一覧を表示
      await displayScenes();

      // 日本語以外の場合はローディング表示を終了
      if (currentLanguage !== 'ja') {
        console.log('🔄 初期読み込み時のローディング表示終了');
        hideLoading();
      }
    });

    // オノマトペデータを読み込み
    async function loadOnomatopoeiaData() {
      try {
        const response = await fetch('/data/dictionary.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const rawData = await response.json();

        // romajiを大文字に変換
        onomatopoeiaData = rawData.map(item => ({
          ...item,
          romaji: item.romaji ? item.romaji.toUpperCase() : item.romaji
        }));

        console.log(`📚 Loaded ${onomatopoeiaData.length} onomatopoeia entries`);
      } catch (error) {
        console.error('オノマトペデータの読み込みに失敗:', error);
        onomatopoeiaData = [];
      }
    }

                // 言語切り替え
    async function changeLanguage(lang) {
      console.log('🔄 changeLanguage 開始:', lang);
      console.log('🔄 現在の言語:', currentLanguage);
      console.log('🔄 引数の言語:', lang);

      if (currentLanguage === lang) {
        console.log('⚠️ 同じ言語なので処理をスキップ');
        return;
      }

      console.log('🔄 言語設定を変更中...');
      currentLanguage = lang;
      console.log('🔄 新しい言語設定:', currentLanguage);

      console.log('🔄 localStorage に保存中...');
      localStorage.setItem('onomatopoeiaLanguage', lang);
      console.log('✅ localStorage 保存完了');

      console.log('🔄 言語ボタンを更新中...');
      updateLanguageButtons();
      console.log('✅ 言語ボタン更新完了');

      // ローディング表示を開始
      console.log('📱 showLoading() 呼び出し前');
      console.log('📱 showLoading 関数の存在確認:', typeof showLoading);
      showLoading();
      console.log('📱 showLoading() 呼び出し後');

      try {
        console.log('🔄 displayScenes() 呼び出し開始');
        // シーン一覧を再表示（翻訳付き）
        await displayScenes();
        console.log('✅ displayScenes() 完了');

        // 最小表示時間を確保（ローディング表示を確実に見せるため）
        console.log('⏱️ 800ms 待機開始');
        await new Promise(resolve => setTimeout(resolve, 800));
        console.log('⏱️ 800ms 待機完了');
      } finally {
        // 必ずローディング表示を終了
        console.log('📱 hideLoading() 呼び出し');
        hideLoading();
        console.log('✅ changeLanguage 完了');
      }
    }

    // ローディング表示の制御
    function showLoading() {
      console.log('📱 showLoading() 実行開始');
      console.log('📱 document の状態:', document.readyState);
      console.log('📱 document.getElementById の存在確認:', typeof document.getElementById);

      const loadingIndicator = document.getElementById('loading-indicator');
      console.log('📱 loadingIndicator 要素:', loadingIndicator);
      console.log('📱 loadingIndicator の型:', typeof loadingIndicator);
      console.log('📱 loadingIndicator の tagName:', loadingIndicator ? loadingIndicator.tagName : 'null');
      console.log('📱 loadingIndicator の id:', loadingIndicator ? loadingIndicator.id : 'null');
      console.log('📱 loadingIndicator の現在の style.display:', loadingIndicator ? loadingIndicator.style.display : 'null');

      if (loadingIndicator) {
        console.log('📱 style.display を block に設定中...');
        loadingIndicator.style.display = 'block';
        console.log('📱 設定後の style.display:', loadingIndicator.style.display);
        console.log('✅ ローディング表示を表示しました');
      } else {
        console.error('❌ loading-indicator 要素が見つかりません');
        console.error('❌ document 全体を確認:', document);
        console.error('❌ 全ての要素を確認:', document.querySelectorAll('*'));
      }
    }

    function hideLoading() {
      console.log('📱 hideLoading() 実行開始');
      const loadingIndicator = document.getElementById('loading-indicator');
      console.log('📱 loadingIndicator 要素:', loadingIndicator);
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
        console.log('✅ ローディング表示を非表示にしました');
      } else {
        console.error('❌ loading-indicator 要素が見つかりません');
      }
    }

    // 言語ボタンの状態更新
    function updateLanguageButtons() {
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.lang === currentLanguage) {
          btn.classList.add('active');
        }
      });
    }

    // シーン一覧を表示
    async function displayScenes() {
      console.log('🔄 displayScenes() 開始, 現在の言語:', currentLanguage);
      const scenesContainer = document.getElementById('scenes-grid');
      if (!scenesContainer) {
        console.error('❌ scenes-grid 要素が見つかりません');
        return;
      }

      // シーンをグループ化
      const sceneGroups = {};
      onomatopoeiaData.forEach(item => {
        if (!sceneGroups[item.scene]) {
          sceneGroups[item.scene] = [];
        }
        sceneGroups[item.scene].push(item);
      });

      let html = '';
      const scenes = Object.keys(sceneGroups);
      console.log('📊 シーン数:', scenes.length, 'シーン:', scenes);

      // 日本語以外の場合は翻訳を実行
      if (currentLanguage !== 'ja') {
        console.log('🌐 翻訳処理開始, 言語:', currentLanguage);
        try {
          // キャッシュから翻訳結果を取得
          let translatedScenes = translationCache.get('scene_titles', currentLanguage);

          if (!translatedScenes) {
            // キャッシュにない場合は翻訳を実行
            console.log(`🚀 シーンタイトル翻訳開始: ${currentLanguage}`);
            translatedScenes = await translationAPI.translateMultipleTexts(scenes, currentLanguage);

            // 翻訳結果をキャッシュに保存
            translationCache.set('scene_titles', currentLanguage, translatedScenes);
          } else {
            console.log(`📦 シーンタイトルキャッシュヒット: ${currentLanguage}`);
            // キャッシュヒット時も少し待機してローディング表示を維持
            await new Promise(resolve => setTimeout(resolve, 500));
          }

          for (let i = 0; i < scenes.length; i++) {
            const originalScene = scenes[i];
            const translatedScene = translatedScenes[i];
            const count = sceneGroups[originalScene].length;

            html += `
              <div class="scene-card" onclick="selectScene('${originalScene}')">
                <div class="scene-icon">📚</div>
                <div class="scene-title">${translatedScene}</div>
              </div>
            `;
          }

        } catch (error) {
          console.error('シーン翻訳エラー:', error);
          // エラー時は元のシーン名で表示
          scenes.forEach(scene => {
            const count = sceneGroups[scene].length;
            html += `
              <div class="scene-card" onclick="selectScene('${scene}')">
                <div class="scene-icon">📚</div>
                <div class="scene-title">${scene}</div>
              </div>
            `;
          });
        } finally {
          // 翻訳処理完了（ローディング表示は changeLanguage 関数で制御）
        }
      } else {
        // 日本語の場合は翻訳不要
        scenes.forEach(scene => {
          const count = sceneGroups[scene].length;
          html += `
            <div class="scene-card" onclick="selectScene('${scene}')">
              <div class="scene-icon">📚</div>
              <div class="scene-title">${scene}</div>
            </div>
          `;
        });
      }

      scenesContainer.innerHTML = html;
    }

    // シーンを選択
    function selectScene(scene) {
      // ローディング表示を開始
      showLoading();

      // 少し待機してからページ遷移（ローディング表示を確実に見せるため）
      setTimeout(() => {
        // URLパラメータでシーン名と言語設定を渡す
        const encodedScene = encodeURIComponent(scene);
        window.location.href = `onomatopoeia-examples.html?scene=${encodedScene}&lang=${currentLanguage}`;
      }, 300);
    }
  </script>
</body>
</html>
