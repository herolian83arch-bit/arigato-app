<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ªãƒãƒãƒˆãƒšè¾å…¸ - ä¾‹æ–‡ | Arigato App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1 id="scene-title">ã‚ªãƒãƒãƒˆãƒšè¾å…¸</h1>
      <div class="back-navigation">
        <button class="back-btn" onclick="window.location.href='onomatopoeia-scenes.html'">â† Back</button>
      </div>
    </header>

    <main>
      <div id="examples-container">
        <!-- ä¾‹æ–‡ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
      </div>
    </main>
  </div>

  <script src="translation-api.js"></script>
  <script src="translation-batch.js"></script>
  <script src="translation-cache.js"></script>
  <script>
    let onomatopoeiaData = [];
    let currentScene = '';
    let currentLanguage = 'ja';
    let translationAPI = null;
    let batchTranslationManager = null;
    let translationCache = null;

    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã®ç¢ºèª
    document.addEventListener('DOMContentLoaded', async function() {
      const isPremium = localStorage.getItem('premiumActive') === 'true';
      if (!isPremium) {
        // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„å ´åˆã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = 'index.html';
        return;
      }

      // ç¿»è¨³APIã®åˆæœŸåŒ–
      translationAPI = new TranslationAPI();
      batchTranslationManager = window.batchTranslationManager;
      translationCache = window.translationCache;

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚·ãƒ¼ãƒ³åã¨è¨€èªã‚’å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      currentScene = urlParams.get('scene');
      currentLanguage = urlParams.get('lang') || 'ja';

      if (!currentScene) {
        // ã‚·ãƒ¼ãƒ³åãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚·ãƒ¼ãƒ³é¸æŠç”»é¢ã«æˆ»ã‚‹
        window.location.href = 'onomatopoeia-scenes.html';
        return;
      }

      // ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
      // ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³ã—ã¦è¡¨ç¤º
      await updateSceneTitle(currentScene);

      // ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await loadOnomatopoeiaData();
      // ä¾‹æ–‡ã‚’è¡¨ç¤ºï¼ˆç¿»è¨³ä»˜ãï¼‰
      await displayExamples();
    });

    // ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³ã—ã¦è¡¨ç¤º
    async function updateSceneTitle(scene) {
      const titleElement = document.getElementById('scene-title');

      if (currentLanguage !== 'ja') {
        try {
          // ç¿»è¨³APIã§ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³
          const translatedTitle = await translationAPI.translateText(scene, currentLanguage);
          titleElement.textContent = translatedTitle;
        } catch (error) {
          console.error('ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®æ—¥æœ¬èªã‚’è¡¨ç¤º
          titleElement.textContent = scene;
        }
      } else {
        // æ—¥æœ¬èªã®å ´åˆã¯ç¿»è¨³ä¸è¦
        titleElement.textContent = scene;
      }
    }

    // ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadOnomatopoeiaData() {
      try {
        const response = await fetch('/data/dictionary.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const rawData = await response.json();

        // romajiã‚’å¤§æ–‡å­—ã«å¤‰æ›
        onomatopoeiaData = rawData.map(item => ({
          ...item,
          romaji: item.romaji ? item.romaji.toUpperCase() : item.romaji
        }));

        console.log(`ğŸ“š Loaded ${onomatopoeiaData.length} onomatopoeia entries`);
      } catch (error) {
        console.error('ã‚ªãƒãƒãƒˆãƒšãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        onomatopoeiaData = [];
      }
    }

    // ä¾‹æ–‡ã‚’è¡¨ç¤ºï¼ˆç¿»è¨³æ©Ÿèƒ½ä»˜ãï¼‰
    async function displayExamples() {
      const examplesContainer = document.getElementById('examples-container');

      // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®ä¾‹æ–‡ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const sceneItems = onomatopoeiaData.filter(item => item.scene === currentScene);

      if (sceneItems.length === 0) {
        examplesContainer.innerHTML = '<p>ã“ã®ã‚·ãƒ¼ãƒ³ã®ä¾‹æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        return;
      }

      // æ—¥æœ¬èªä»¥å¤–ã®å ´åˆã¯ç¿»è¨³ã‚’å®Ÿè¡Œ
      if (currentLanguage !== 'ja') {
        try {
          // ç¿»è¨³å‡¦ç†ä¸­ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
          showLoading();

          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ç¿»è¨³çµæœã‚’å–å¾—
          let translatedItems = translationCache.get(currentScene, currentLanguage);

          if (!translatedItems) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã„å ´åˆã¯ç¿»è¨³ã‚’å®Ÿè¡Œ
            console.log(`ğŸš€ ä¾‹æ–‡ç¿»è¨³é–‹å§‹: ${currentScene} (${currentLanguage})`);
            translatedItems = await batchTranslationManager.translateSceneBatch(sceneItems, currentLanguage, currentScene);

            // ç¿»è¨³çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            translationCache.set(currentScene, currentLanguage, translatedItems);
          } else {
            console.log(`ğŸ“¦ ä¾‹æ–‡ç¿»è¨³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: ${currentScene} (${currentLanguage})`);
          }

          // ç¿»è¨³ã•ã‚ŒãŸä¾‹æ–‡ã‚’è¡¨ç¤º
          displayTranslatedExamples(translatedItems);

        } catch (error) {
          console.error('ä¾‹æ–‡ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®æ—¥æœ¬èªã§è¡¨ç¤º
          displayTranslatedExamples(sceneItems);
        } finally {
          // å¿…ãšãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’çµ‚äº†
          hideLoading();
        }
      } else {
        // æ—¥æœ¬èªã®å ´åˆã¯ç¿»è¨³ä¸è¦
        displayTranslatedExamples(sceneItems);
      }
    }

    // ä¾‹æ–‡ã‚’è¡¨ç¤ºï¼ˆç¿»è¨³æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
    function displayTranslatedExamples(items) {
      const examplesContainer = document.getElementById('examples-container');

      let html = '';
      for (const item of items) {
        // éŸ³å£°å†ç”Ÿæ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹ãƒã‚§ãƒƒã‚¯
        const isTTSEnabled = localStorage.getItem('feature_tts') === '1' ||
                             (typeof window !== 'undefined' && window.speechSynthesis);

        // ç¿»è¨³ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ï¼ˆç¿»è¨³ãŒãªã„å ´åˆã¯å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ï¼‰
        const mainText = item.main || item.originalMain || '';
        const descriptionText = (item.description && item.description[currentLanguage]) ||
                               (item.description && item.description.ja) ||
                               item.originalDescription || '';

        html += `
          <div class="onomatopoeia-item" data-testid="dict-row">
            <div class="item-header">
              <div class="item-number">${item.id}</div>
              <div class="item-actions" style="display:inline-flex;align-items:center;">
                ${isTTSEnabled ? `
                  <button class="speak-btn" onclick="playAudio('${(item.jpsen || '').replace(/'/g, "\\'")}')" aria-label="éŸ³å£°å†ç”Ÿ" style="background:none;border:none;cursor:pointer;font-size:1.2em;margin-left:12px;" data-card-control="true">
                    ğŸ”Š
                  </button>
                ` : ''}
                <button class="favorite-toggle-btn" data-card-control="true" aria-label="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ " style="background:none;border:none;cursor:pointer;padding:8px;margin-left:12px;font-size:1.3em;color:#bbb;min-width:40px;min-height:40px;display:inline-flex;align-items:center;justify-content:center;transition:all 0.2s ease;border-radius:4px;position:relative;z-index:10;pointer-events:auto;" onclick="toggleFavorite(${item.id}, this)">
                  ${isFavorite(item.id) ? 'â˜…' : 'â˜†'}
                </button>
              </div>
            </div>
            <div class="item-main">${mainText}</div>
            <div class="item-romaji">${item.romaji}</div>
            <div class="item-description">${descriptionText}</div>
          </div>
        `;
      }

      examplesContainer.innerHTML = html;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®åˆ¶å¾¡
    function showLoading() {
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
      }
    }

    function hideLoading() {
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
    }

    // éŸ³å£°å†ç”Ÿ
    function playAudio(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ja-JP';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 0.9;
        speechSynthesis.speak(utterance);
      }
    }

    // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã®ç¢ºèª
    function isFavorite(id) {
      if (!id) return false;
      try {
        const favorites = JSON.parse(localStorage.getItem('arigato_favorites_v1') || '{}');
        return favorites[String(id)] === true;
      } catch {
        return false;
      }
    }

    // ãŠæ°—ã«å…¥ã‚Šã®åˆ‡ã‚Šæ›¿ãˆ
    function toggleFavorite(id, button) {
      if (!id) return false;

      try {
        const favorites = JSON.parse(localStorage.getItem('arigato_favorites_v1') || '{}');
        const stringId = String(id);
        const currentState = favorites[stringId] || false;
        const newState = !currentState;

        favorites[stringId] = newState;
        localStorage.setItem('arigato_favorites_v1', JSON.stringify(favorites));

        // UIæ›´æ–°
        if (newState) {
          button.innerHTML = 'â˜…';
          button.style.color = '#ffd700';
          button.style.transform = 'scale(1.1)';
          button.setAttribute('aria-label', 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤');
          button.setAttribute('aria-pressed', 'true');
        } else {
          button.innerHTML = 'â˜†';
          button.style.color = '#bbb';
          button.style.transform = 'scale(1)';
          button.setAttribute('aria-label', 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ');
          button.setAttribute('aria-pressed', 'false');
        }

        return newState;
      } catch (error) {
        console.warn('Failed to toggle favorite:', error);
        return false;
      }
    }
  </script>
</body>
</html>
